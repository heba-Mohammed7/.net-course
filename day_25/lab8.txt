--1--
create view StudentCourseGrades
as
select 
    s.St_Fname + ' ' + s.St_Lname as FullName,
    c.Crs_Name
from Student s
join Stud_Course sc on s.St_Id = sc.St_Id
join Course c on sc.Crs_Id = c.Crs_Id
where sc.Grade > 50;

--2--
create view EncryptedManagerTopics
with encryption
as
select Ins.Ins_Name as ManagerName , Top_Name as Topic from Department as Dept 
	inner join  Instructor as Ins on Dept.Dept_Manager = ins.Ins_Id 
	inner join Ins_Course on ins.Ins_Id=Ins_Course.Ins_Id
	inner join Course on Ins_Course.Crs_Id = Course.Crs_Id
	inner join Topic on Topic.Top_Id = Course.Top_Id

--3--
create view InstructorDepartment
as
select 
    i.Ins_Name,
    d.Dept_Name
from Instructor i
join Department d on i.Dept_Id = d.Dept_Id
where d.Dept_Name in ('SD', 'Java');

--4--
create view V1
with schemabinding
as
select 
    St_Id,
    St_Fname,
    St_Lname,
    St_Address
from dbo.Student
where St_Address in ('Alex', 'Cairo');

Update V1 set st_address='tanta'
Where st_address='alex';

--5--
create view ProjectEmployeeCount
as
select 
    p.Pname as ProjectName,
    count(distinct w.ESSn) as NumberOfEmployees
from Project p
left join Works_for w on p.Pnumber = w.Pno
group by p.Pname;


--6--
create clustered index idx_Hiredate on Department(Manager_hiredate);

--7--
create unique index idx_UniqueAge on Student(St_Age);

-----------------------------------------------------------------------------
--1--
create view v_clerk
as
select 
    e.EmpNo,
    w.ProjectNo,
    w.Enter_Date
from HR.Employee e
join dbo.Works_on w on e.EmpNo = w.EmpNo
where w.Job = 'Clerk';

--2--
create view v_without_budget
as
select 
    ProjectNo,
    ProjectName
from HR.Project
where Budget is null;

--3--
create view v_count
as
select 
    p.ProjectName,
    count(w.ProjectNo) as JobCount
from HR.Project p
left join dbo.Works_on w on p.ProjectNo = w.ProjectNo
group by p.ProjectName;

--4-- 
CREATE VIEW v_project_p2
AS
SELECT 
    v.EmpNo
FROM v_clerk v
JOIN dbo.Works_on w ON v.EmpNo = w.EmpNo
JOIN HR.Project p ON w.ProjectNo = p.ProjectNo
WHERE p.ProjectName = 'p2';

--5-- 
alter view v_without_budget
as
select 
    ProjectNo,
    ProjectName
from HR.Project
where ProjectName in ('p1', 'HD');


ALTER VIEW v_without_budget
AS
SELECT 
    *
FROM HR.Project
WHERE ProjectName IN ('p1', 'p2');

--6--

drop view v_clerk;
drop view v_count;
--7-- 

CREATE VIEW v_emp_dept_d2
AS
SELECT 
    e.EmpNo AS EmpNumber,
    e.EmpLname AS LastName
FROM HR.Employee e
JOIN Company.Department d ON e.DeptNo = d.DeptNo
WHERE d.DeptName = 'd2';

--8-- 
SELECT 
    LastName
FROM v_emp_dept_d2
WHERE LastName LIKE '%J%';

--9--
create view v_dept
as
select 
    DeptNo,
    DeptName
from Company.Department;

--10--
create view v_2006_check
with schemabinding
as
select 
    e.EmpNo,
    w.ProjectNo,
    w.Enter_Date
from HR.Employee e
join dbo.Works_on w on e.EmpNo = w.EmpNo
where w.Enter_Date between '2006-01-01' and '2006-12-31';

create trigger trg_v_2006_check_Insert
on v_2006_check
instead of insert
as
begin
    insert into dbo.Works_on (EmpNo, ProjectNo, Enter_Date)
    select i.EmpNo, i.ProjectNo, i.Enter_Date
    from inserted i
    where i.Enter_Date between '2006-01-01' and '2006-12-31';
    if @@ROWCOUNT = 0
        print 'Insert failed: Hire_Date must be between January 1, 2006 and December 31, 2006';
end;